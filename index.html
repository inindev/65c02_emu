<html>
<head>
  <meta charset="utf-8"/>
  <meta name="description" content="w65c02s emulator">
  <meta name="author" content="John Clark">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>w65c02s emulator</title>
  <style type="text/css">
    body {
        margin: 0px;
        padding: 0px;
        border: 0px;        
        font-size: 13px;
        font-family: "Lucida Console", Monaco, monospace;
        background: #e1e1d0;
    }
    #regdisp {
        margin-top: .7em;
        margin-bottom: .7em;
        padding: 1em;
        border: 1px solid #999;
        width: 24em;
        background: #f5f5ef;
    }
    button {
        margin: 4px;
        border: 1px solid #c5c5c5;
        border-radius: 3px;
        width: 6em;
        height: 2em;
        font-size: 14px;
        color: #f5f5ef;
        background: #734d26;
    }
    button:active {
        color: #520;
        background: #499;
    }
    .row {
        padding: 4em;
        display: flex;
    }
    .col1 {
        float: left;
        padding: 1em;
        min-width: 31em;
        overflow: hidden;
        box-sizing: border-box;
    }
    .col2 {
        float: left;
        padding: 1em;
        min-width: 20em;
        overflow: hidden;
        box-sizing: border-box;
    }
    .col3 {
        float: left;
        flex: 1;
        overflow: hidden;
        box-sizing: border-box;
    }
    .row:after {
        content: "";
        display: table;
        clear: both;
    }
    .hexdata {
        margin-top: 2em;
    }
    .hexdata>div {
        font-size: 11px;
    }
    .hexdata>div>span {
        padding: 1px;
    }
    .hexdata>div>span.active {
        background: #fc5b2f;
    }
    .hexdata>div>input:not([type=checkbox]) {
        margin: 3px;
        padding-left: 1em; 
        width: 6em;
        font-size: 12px;
        border: 1px solid #c5c5c5;
        background: #fefef7;
    }
  </style>
</head>

<body>
  <div class="row">

    <div class="col1">
      <div id="regdisp">
        <div>a = 00&nbsp;&nbsp;&nbsp;pc = 0000</div>
        <div>x = 00&nbsp;&nbsp;&nbsp;sp =&nbsp;&nbsp;&nbsp;ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n v . b&nbsp;&nbsp;d i z c</div>
        <div>y = 00&nbsp;&nbsp;&nbsp;sf =&nbsp;&nbsp;&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 0 + 0&nbsp;&nbsp;0 0 0 0</div>
      </div>
      <div><button id="step">step</button><button id="reset">reset</button></div>
      <div id="output" style="margin: 1em; margin-top: 2em;"></div>
    </div>

    <div class="col2">
      <div class="hexdata">
        <div><span></span><input> 2000 <input type="checkbox"></div>
        <div><span></span><input> 2001 <input type="checkbox"></div>
        <div><span></span><input> 2002 <input type="checkbox"></div>
        <div><span></span><input> 2003 <input type="checkbox"></div>
        <div><span></span><input> 2004 <input type="checkbox"></div>
        <div><span></span><input> 2005 <input type="checkbox"></div>
        <div><span></span><input> 2006 <input type="checkbox"></div>
        <div><span></span><input> 2007 <input type="checkbox"></div>
        <div>&nbsp;</div>
        <div><span></span><input> 2008 <input type="checkbox"></div>
        <div><span></span><input> 2009 <input type="checkbox"></div>
        <div><span></span><input> 200a <input type="checkbox"></div>
        <div><span></span><input> 200b <input type="checkbox"></div>
        <div><span></span><input> 200c <input type="checkbox"></div>
        <div><span></span><input> 200d <input type="checkbox"></div>
        <div><span></span><input> 200e <input type="checkbox"></div>
        <div><span></span><input> 200f <input type="checkbox"></div>
    </div>
    </div>

    <div class="col3">
    </div>
  </div>


  <script src="w65c02s.js"></script>
  <script>
    var cycles;
    var output;
    var hexval;

    function test_and_imm(offs) {
        offs= offs | 0x2000;
        ram.write(offs++, 0xa9); // lda, #$fa
        ram.write(offs++, 0xfa); //
        ram.write(offs++, 0x29); // and, #$af
        ram.write(offs++, 0xaf); //
        ram.write(offs++, 0xc9); // cmp, 0xaa - (z & c set if pass)
        ram.write(offs++, 0xaa); //
        ram.write(offs++, 0x00); // brk
    }
    function test_and_abs(offs) {
        offs= offs | 0x2000;
        ram.write(0x0002, 0xaf);

        ram.write(offs++, 0xa9); // lda, #$fa
        ram.write(offs++, 0xfa); //
        ram.write(offs++, 0x2d); // and, $0002
        ram.write(offs++, 0x02); //
        ram.write(offs++, 0x00); //
        ram.write(offs++, 0xc9); // cmp, 0xaa - (z & c set if pass)
        ram.write(offs++, 0xaa); //
        ram.write(offs++, 0x00); // brk
    }

    function setup() {
        test_and_abs();
/*
        let offs = 0x2000;
        ram.write(offs++, 0xce); // dec
        ram.write(offs++, 0x07);
        ram.write(offs++, 0x20);
        ram.write(offs++, 0x00);
        ram.write(offs++, 0x00);
        ram.write(offs++, 0x00);
        ram.write(offs++, 0x00);
        ram.write(offs++, 0x80);
*/
//        ram.write(0x2000, 0x18); // clc
//        ram.write(0x2000, 0x38); // sec
//        ram.write(0x2001, 0xf8); // sed
//        ram.write(0x2002, 0xa9); // lda
//        ram.write(0x2003, 0xe0);
//        ram.write(0x2004, 0xe9); // sbc
//        ram.write(0x2005, 0xc0);

        for(let i=0; i<hexval.length; i++) {
            hexval[i].value = ram.read(0x2000 + i).toString(16).padStart(2, '0');
        }

        cpu.register.pc = 0x2000;
        hexval[0].parentNode.firstChild.classList.add('active');
        update_regs(cpu.register);
        cycles = 0;
    }

    function step() {
        for(let i=0; i<hexval.length; i++) {
            ram.write(0x2000 + i, parseInt(hexval[i].value, 16));
        }

        const res = cpu.step();
        if(res < 1) {
            message("step returned: " + res);
            return;
        }
        cycles += res;

        update_regs(cpu.register);
        message("cycles: " + cycles, true);

        for(let i=0; i<hexval.length; i++) {
            hexval[i].value = ram.read(0x2000 + i).toString(16).padStart(2, '0');
            if(i == (cpu.register.pc-0x2000)) {
                hexval[i].parentNode.firstChild.classList.add('active');
            } else {
                hexval[i].parentNode.firstChild.classList.remove('active');
            }
        }
    }

    function reset() {
        cpu.reset();
        cpu.register.pc = 0x2000;
        for(let i=0; i<hexval.length; i++) {
            if(i == (cpu.register.pc-0x2000)) {
                hexval[i].parentNode.firstChild.classList.add('active');
            } else {
                hexval[i].parentNode.firstChild.classList.remove('active');
            }
        }
        update_regs(cpu.register);
        cycles = 0;
        message();
    }

    function message(text, c) {
        if(!text || c) {
            output.innerHTML = "";
            if(!c) return;
        }
        output.innerHTML += ("<p>" + text + "</p>");
    }

    function update_regs(reg) {
        var flag_str;
        flag_str  = (reg.flag.n) ? "1 " : "0 ";
        flag_str += (reg.flag.v) ? "1 " : "0 ";
        flag_str += "+ ";
        flag_str += (reg.flag.b) ? "1 " : "0 ";
        flag_str += "&nbsp;";
        flag_str += (reg.flag.d) ? "1 " : "0 ";
        flag_str += (reg.flag.i) ? "1 " : "0 ";
        flag_str += (reg.flag.z) ? "1 " : "0 ";
        flag_str += (reg.flag.c) ? "1 " : "0 ";

        regdisp.innerHTML  = "<div>a = " +reg.a.toString(16).padStart(2, '0')+ "&nbsp;&nbsp;&nbsp;pc = " +reg.pc.toString(16).padStart(4, '0')+ "</div>";
        regdisp.innerHTML += "<div>x = " +reg.x.toString(16).padStart(2, '0')+ "&nbsp;&nbsp;&nbsp;sp = &nbsp;&nbsp;" +reg.sp.toString(16).padStart(2, '0')+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n v . b &nbsp;d i z c</div>";
        regdisp.innerHTML += "<div>y = " +reg.y.toString(16).padStart(2, '0')+ "&nbsp;&nbsp;&nbsp;sf = &nbsp;&nbsp;" +reg.flag.value.toString(16).padStart(2, '0')+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +flag_str+ "</div>";
    }

    function init() {
        output = document.getElementById("output");
        regdisp = document.getElementById("regdisp");
        hexval = document.querySelectorAll("div.hexdata>div>input:not([type=checkbox]");
        document.getElementById("step").addEventListener("click", step);
        document.getElementById("reset").addEventListener("click", reset);
        setup();
    }

    if(document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }        
  </script>
</body>
</html>

